<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <!-- bootstrap init -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
      crossorigin="anonymous"
    ></script>

    <title>Fintra</title>
  </head>
  <body>
    <!-- Bootstrap container for layout -->
    <div class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-6">
          <!-- A standard Bootstrap card component -->
          <div class="card text-center shadow-sm-5 mb-3">
            <div class="card-header">Account Information</div>
            <div class="card-body">
              <div class="row justify-content-center">
                <div class="col-md-6">
                  <h5 class="card-title">Signed is as</h5>
                  <p id="username-display"></p>
                </div>

                <div class="col-md-6">
                  <form action="/api/logout" method="POST">
                    <button class="btn btn-danger">Log out</button>
                  </form>
                </div>
              </div>

              <h5 class="card-title">Current Balance</h5>

              <div id="balance-display"></div>
              <button id="balance-display-btn" class="btn btn-primary">
                Fetch Balance
              </button>
            </div>
          </div>

          <div class="card text-center shadow-sm mb-3">
            <div class="card-header">Actions</div>
            <div class="card-body">
              <h5 class="card-title">Submit Transaction</h5>
              <form id="submit-transaction-form">
                <div class="mb-3">
                  <label for="moneyAmount" class="form-label">Amount</label>
                  <input
                    type="number"
                    class="form-control"
                    id="moneyAmount"
                    name="amount"
                    step="0.01"
                    placeholder="e.g., 50.00"
                  />
                </div>
                <div class="mb-3">
                  <label for="transactionType" class="form-label">Type</label>
                  <select class="form-select" id="transactionType" name="type">
                    <option selected disabled>Select type...</option>
                    <option value="income">Income</option>
                    <option value="expense">Expense</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="transactionCategory" class="form-label"
                    >Category</label
                  >
                  <select
                    class="form-select"
                    id="transactionCategory"
                    name="category"
                  >
                    <option selected disabled>Select category...</option>
                    <option value="food">Food</option>
                    <option value="transport">Transport</option>
                    <option value="bills">Bills</option>
                    <option value="salary">Salary</option>
                    <option value="entertainment">Entertainment</option>
                    <option value="health">Health</option>
                    <option value="housing">Housing</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="transactionDescription" class="form-label"
                    >Description</label
                  >
                  <textarea
                    class="form-control"
                    id="transactionDescription"
                    name="description"
                    rows="3"
                    placeholder="Brief description of the transaction..."
                  ></textarea>
                </div>
                <div class="mb-3">
                  <label for="transactionParty" class="form-label">Party</label>
                  <input
                    type="text"
                    class="form-control"
                    id="transactionParty"
                    name="party"
                    placeholder="e.g., Jane Doe / ABC Corp"
                  />
                </div>
                <div class="mb-3">
                  <label for="transactionDateTime" class="form-label"
                    >Date and Time</label
                  >
                  <input
                    type="datetime-local"
                    class="form-control"
                    id="transactionDateTime"
                    name="date"
                  />
                </div>

                <button id="submit-transaction-btn" class="btn btn-primary">
                  Submit
                </button>
              </form>
              <div id="action-display" class="mt-3">
                <!-- Response from transaction submission will be displayed here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      function getUserIdentifier() {
        const cookieString = `; ${document.cookie}`;
        const parts = cookieString.split(`; email=`);
        if (parts.length === 2) {
          const value = parts.pop().split(";").shift();
          return value.replace(/^"|"$/g, "");
        }
      }

      function getBalance() {
        const balanceDisplay = document.getElementById("balance-display");
        if (!balanceDisplay) {
          console.error("Element with id 'balance-display' not found.");
          return;
        }
        fetch("/api/balance")
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            const balanceValue = data.balance;
            balanceDisplay.innerHTML = `<h3 class="text-success">${balanceValue}</h3>`;
          })
          .catch((error) => {
            console.error("Error fetching balance:", error);
            balanceDisplay.innerHTML = `<p class="text-danger">Failed to load balance.</p>`;
          });
      }
      function submitTransaction() {
        const submitTransactionForm = document.getElementById(
          "submit-transaction-form",
        );

        if (submitTransactionForm) {
          const formData = new FormData(submitTransactionForm);
          const transactionData = Object.fromEntries(formData.entries());

          fetch("/api/transaction", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(transactionData),
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then((data) => {
              console.log("Transaction submitted successfully:", data);
            })
            .catch((error) => {
              console.error("Error submitting transaction:", error);
            });
        } else {
          console.log("Form not found.");
        }
        getBalance();
      }

      const submitTransactionForm = document.getElementById(
        "submit-transaction-form",
      );
      submitTransactionForm.addEventListener("submit", function (event) {
        // Prevent the default form submission, which causes a page reload
        event.preventDefault();

        submitTransaction();
      });

      const fetchBalanceButton = document.querySelector(
        "button#balance-display-btn",
      );
      if (fetchBalanceButton) {
        fetchBalanceButton.onclick = getBalance;
      }
      window.onload = function () {
        const displayElement = document.getElementById("username-display");
        const username = getUserIdentifier();
        displayElement.textContent = username;
        getBalance();
      };
    </script>
  </body>
</html>
